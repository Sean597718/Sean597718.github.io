<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>手機版 Map8 導航</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-F3w7mX95PdgyTmZZMECAngseQB83DfGTowi0iMjiWaeVhAn4FJkqJByhZMI3AhiU" crossorigin="anonymous">
    <script src="https://cdn.staticfile.org/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdn.staticfile.org/popper.js/2.9.3/umd/popper.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" />
    <script src="https://kit.fontawesome.com/e4b7016783.js" crossorigin="anonymous"></script>
    <link
        href="https://api.map8.zone/css/gomp.css?key=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJqaW5icy5pbmZvQGdtYWlsLmNvbSIsIm5hbWUiOiJqaW5icy5pbmZvQGdtYWlsLmNvbSIsImlhdCI6MTcxNzYzODg0Niwib2JqZWN0cyI6WyJcL21hcHNcL2pzIiwiXC9tYXBzXC9zdGF0aWMiLCJcL3BsYWNlXC9nZW9jb2RlIiwiXC9wbGFjZVwvZmluZHBsYWNlZnJvbXRleHQiLCJcL3BsYWNlXC9uZWFyYnlzZWFyY2giLCJcL3BsYWNlXC90ZXh0c2VhcmNoIiwiXC9wbGFjZVwvYXV0b2NvbXBsZXRlIiwiXC9kYXRhIiwiXC9zdHlsZXMiLCJcL3Nwcml0ZXMiLCJcL2ZvbnRzIiwiXC9yb3V0ZVwvZGlyZWN0aW9ucyIsIlwvcm91dGVcL2Rpc3RhbmNlbWF0cml4IiwiXC9yb3V0ZVwvdHJpcCIsIlwvcm9hZFwvbmVhcmVzdFJvYWRzIiwiXC9yb2FkXC9zbmFwVG9Sb2FkcyIsIlwvcm91dGVcL3ZycCIsIlwvYWRkcmVzc1wvc3RhbmRhcmRpemF0aW9uIl0sImV4cCI6MTcyMDE3MTgwNn0.Bk_GgGRH-vpYD-Rq4NDMa7XoiJ12LAadPBdTEA20Sh4"
        rel="stylesheet">
    <script type="text/javascript"
        src="https://api.map8.zone/maps/js/gomp-web-service-js-client.min.js?key=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJqaW5icy5pbmZvQGdtYWlsLmNvbSIsIm5hbWUiOiJqaW5icy5pbmZvQGdtYWlsLmNvbSIsImlhdCI6MTcxNzYzODg0Niwib2JqZWN0cyI6WyJcL21hcHNcL2pzIiwiXC9tYXBzXC9zdGF0aWMiLCJcL3BsYWNlXC9nZW9jb2RlIiwiXC9wbGFjZVwvZmluZHBsYWNlZnJvbXRleHQiLCJcL3BsYWNlXC9uZWFyYnlzZWFyY2giLCJcL3BsYWNlXC90ZXh0c2VhcmNoIiwiXC9wbGFjZVwvYXV0b2NvbXBsZXRlIiwiXC9kYXRhIiwiXC9zdHlsZXMiLCJcL3Nwcml0ZXMiLCJcL2ZvbnRzIiwiXC9yb3V0ZVwvZGlyZWN0aW9ucyIsIlwvcm91dGVcL2Rpc3RhbmNlbWF0cml4IiwiXC9yb3V0ZVwvdHJpcCIsIlwvcm9hZFwvbmVhcmVzdFJvYWRzIiwiXC9yb2FkXC9zbmFwVG9Sb2FkcyIsIlwvcm91dGVcL3ZycCIsIlwvYWRkcmVzc1wvc3RhbmRhcmRpemF0aW9uIl0sImV4cCI6MTcyMDE3MTgwNn0.Bk_GgGRH-vpYD-Rq4NDMa7XoiJ12LAadPBdTEA20Sh4"></script>
    <style>
        .container-fluid {
            display: flex;
            flex-direction: column;
            height: 100vh;
            vertical-align: middle;
        }

        .map {
            height: 100%;
            background-color: #f7f7f7;
            border: 2px solid #333;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
            border-radius: 10;
        }

        .alert-success {
            flex-grow: 1;
            width: 100%;
        }

        .card {
            background-color: #f7f7f7;
            margin-top: 6px;
            border: 2px solid #333;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
        }

        .btn {
            margin-top: 6px;
            margin-bottom: 6px;
        }
    </style>
</head>

<body>
    <div class="container-fluid">
        <div id="toastContainer" aria-live="polite" aria-atomic="true"
            style="position: fixed; top: 20px; right: 20px; z-index: 100;"></div>
        <div class="row">
            <div class="col-12">
                <div class="text-white bg-success mb-3 card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">路徑指示</h5>
                        <div>
                            <button class="btn btn-light" id="prevButton">-</button>
                            <button class="btn btn-light" id="nextButton">+</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <h5 id="card-distance" class="card-title">路口距離</h5>
                        <p id="card-instruction" class="card-text">詳細方向指示</p>
                        <p id="card-fare" class="card-text">預估費用</p>
                    </div>
                </div>
            </div>
        </div>
        <!-- Modal for start-->
        <div class="modal fade" id="startModal" tabindex="-1" aria-labelledby="startModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="startModalLabel"><i class="fa-solid fa-file-check fa-lg">行程確認</i>
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p>目的地: <span id="destination"></span></p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-success" data-bs-dismiss="modal"
                            onclick="startJourney()">
                            <i class="bi bi-arrow-90deg-right"></i> 出發</button>
                        <button type="button" class="btn btn-warning" data-bs-dismiss="modal">
                            <i class="bi bi-x-circle-fill"></i> 關閉</button>
                    </div>
                </div>
            </div>
        </div>
        <!-- Modal for end-->
        <div class="modal fade" id="endModal" tabindex="-1" aria-labelledby="endModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="endModalLabel"><i class="fa-solid fa-file-check fa-lg">確認抵達</i></h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <b>請確認是否已抵達乘客上車點</b>
                        <b>送出後將傳送訊息告知乘客！</b>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-success" data-bs-dismiss="modal">
                            <i class="bi bi-clipboard-check-fill"></i> 確認已抵達</button>
                        <button type="button" class="btn btn-warning" data-bs-dismiss="modal">
                            <i class="bi bi-x-circle-fill"></i> 關閉視窗</button>
                    </div>
                </div>
            </div>
        </div>
        <div id="map8Map" class="map"></div>
        <div class="row">
            <div class="d-grid">
                <button class="btn btn-danger btn-block" type="button" data-bs-toggle="modal" data-bs-target="#endModal"
                    onclick="endJourney()">
                    <i class="fa-solid fa-flag-checkered fa-lg"></i><b> 結束行程</b>
                </button>
            </div>
        </div>
        <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.10.1/dist/umd/popper.min.js"
            integrity="sha384-W8fXfP3gkOKtndU4JGtKDvXbO53Wy8SZCQHczT5FMiiqmQfUpWbYdTil/SxwZgAN"
            crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/js/bootstrap.min.js"
            integrity="sha384-skAcpIdS7UcVUC05LJ9Dxay8AXcDYfBJqt1CJ85S/CFujBsIzCIv+l9liuYLaMQ/"
            crossorigin="anonymous"></script>
        <script
            src="https://api.map8.zone/maps/js/gomp.js?key=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJqaW5icy5pbmZvQGdtYWlsLmNvbSIsIm5hbWUiOiJqaW5icy5pbmZvQGdtYWlsLmNvbSIsImlhdCI6MTcxNzYzODg0Niwib2JqZWN0cyI6WyJcL21hcHNcL2pzIiwiXC9tYXBzXC9zdGF0aWMiLCJcL3BsYWNlXC9nZW9jb2RlIiwiXC9wbGFjZVwvZmluZHBsYWNlZnJvbXRleHQiLCJcL3BsYWNlXC9uZWFyYnlzZWFyY2giLCJcL3BsYWNlXC90ZXh0c2VhcmNoIiwiXC9wbGFjZVwvYXV0b2NvbXBsZXRlIiwiXC9kYXRhIiwiXC9zdHlsZXMiLCJcL3Nwcml0ZXMiLCJcL2ZvbnRzIiwiXC9yb3V0ZVwvZGlyZWN0aW9ucyIsIlwvcm91dGVcL2Rpc3RhbmNlbWF0cml4IiwiXC9yb3V0ZVwvdHJpcCIsIlwvcm9hZFwvbmVhcmVzdFJvYWRzIiwiXC9yb2FkXC9zbmFwVG9Sb2FkcyIsIlwvcm91dGVcL3ZycCIsIlwvYWRkcmVzc1wvc3RhbmRhcmRpemF0aW9uIl0sImV4cCI6MTcyMDE3MTgwNn0.Bk_GgGRH-vpYD-Rq4NDMa7XoiJ12LAadPBdTEA20Sh4"></script>
        <script type="text/javascript"
            src="https://api.map8.zone/maps/js/gomp-web-service-js-client.min.js?key=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJqaW5icy5pbmZvQGdtYWlsLmNvbSIsIm5hbWUiOiJqaW5icy5pbmZvQGdtYWlsLmNvbSIsImlhdCI6MTcxNzYzODg0Niwib2JqZWN0cyI6WyJcL21hcHNcL2pzIiwiXC9tYXBzXC9zdGF0aWMiLCJcL3BsYWNlXC9nZW9jb2RlIiwiXC9wbGFjZVwvZmluZHBsYWNlZnJvbXRleHQiLCJcL3BsYWNlXC9uZWFyYnlzZWFyY2giLCJcL3BsYWNlXC90ZXh0c2VhcmNoIiwiXC9wbGFjZVwvYXV0b2NvbXBsZXRlIiwiXC9kYXRhIiwiXC9zdHlsZXMiLCJcL3Nwcml0ZXMiLCJcL2ZvbnRzIiwiXC9yb3V0ZVwvZGlyZWN0aW9ucyIsIlwvcm91dGVcL2Rpc3RhbmNlbWF0cml4IiwiXC9yb3V0ZVwvdHJpcCIsIlwvcm9hZFwvbmVhcmVzdFJvYWRzIiwiXC9yb2FkXC9zbmFwVG9Sb2FkcyIsIlwvcm91dGVcL3ZycCIsIlwvYWRkcmVzc1wvc3RhbmRhcmRpemF0aW9uIl0sImV4cCI6MTcyMDE3MTgwNn0.Bk_GgGRH-vpYD-Rq4NDMa7XoiJ12LAadPBdTEA20Sh4"></script>

        <script type="text/javascript"
            src="https://api.map8.zone/maps/js/map8-js-route.js?key=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJqaW5icy5pbmZvQGdtYWlsLmNvbSIsIm5hbWUiOiJqaW5icy5pbmZvQGdtYWlsLmNvbSIsImlhdCI6MTcxNzYzODg0Niwib2JqZWN0cyI6WyJcL21hcHNcL2pzIiwiXC9tYXBzXC9zdGF0aWMiLCJcL3BsYWNlXC9nZW9jb2RlIiwiXC9wbGFjZVwvZmluZHBsYWNlZnJvbXRleHQiLCJcL3BsYWNlXC9uZWFyYnlzZWFyY2giLCJcL3BsYWNlXC90ZXh0c2VhcmNoIiwiXC9wbGFjZVwvYXV0b2NvbXBsZXRlIiwiXC9kYXRhIiwiXC9zdHlsZXMiLCJcL3Nwcml0ZXMiLCJcL2ZvbnRzIiwiXC9yb3V0ZVwvZGlyZWN0aW9ucyIsIlwvcm91dGVcL2Rpc3RhbmNlbWF0cml4IiwiXC9yb3V0ZVwvdHJpcCIsIlwvcm9hZFwvbmVhcmVzdFJvYWRzIiwiXC9yb2FkXC9zbmFwVG9Sb2FkcyIsIlwvcm91dGVcL3ZycCIsIlwvYWRkcmVzc1wvc3RhbmRhcmRpemF0aW9uIl0sImV4cCI6MTcyMDE3MTgwNn0.Bk_GgGRH-vpYD-Rq4NDMa7XoiJ12LAadPBdTEA20Sh4"></script>
        <script>

            //javascript.js
            //set map options
            let map,
                gompWebServiceJsClient,
                route,
                start_at,
                json;
            let arrivalLatLng = [121.5173399, 25.0475613]; // 目的地座標
            let goState = false; // 是否開始導航
            let stepsPath = []; // 路線暫存
            let currentStepIndex = 1; // 目前所在步驟的索引
            let currentStep = null; // 目前所在步驟
            let nextStep = null; // 下一個步驟
            let nextPoint = null; // 行徑方向下一個點座標
            let mapRotation = 0; // 地圖旋轉角度
            let NowLatLng = null; // 目前所在位置
            let endPosition = null; // 目的地位置
            let positionRecord = []; // 紀錄移動路徑的陣列
            let Pathpolyline = null; // 移動路徑的線段
            let estimatedDistance = 0; // 預估距離
            let moveDistance = 0; // 移動距離
            let totalMoveLength = 0; // 移動路徑的總長度
            let idlePosition = null; // 怠速開始位置
            let Timer = 0; // 計時器
            let startTime = null; // 起始時間
            let endTime = null; // 結束時間
            let nowposition = null; // 目前所在位置
            const cardTextDistance = document.querySelector("#card-distance");
            const cardTextInstruction = document.querySelector("#card-instruction");
            const cardTextFare = document.querySelector("#card-fare");
            let routeData; // 路線資料
            let watchPositionId; // 監聽位置的 ID
            let fare = 0; // 車資
            const totalDistanceElement = document.getElementById("total-distance");
            const totalFareElement = document.getElementById("total-fare");

            //初始化地圖
            let marker;
            let startModal, endModal;
            document.addEventListener("DOMContentLoaded", function () {
                startModal = new bootstrap.Modal(document.getElementById("startModal"));
                endModal = new bootstrap.Modal(document.getElementById("endModal"));
                gomp.accessToken = 'eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJqaW5icy5pbmZvQGdtYWlsLmNvbSIsIm5hbWUiOiJqaW5icy5pbmZvQGdtYWlsLmNvbSIsImlhdCI6MTcxNzYzODg0Niwib2JqZWN0cyI6WyJcL21hcHNcL2pzIiwiXC9tYXBzXC9zdGF0aWMiLCJcL3BsYWNlXC9nZW9jb2RlIiwiXC9wbGFjZVwvZmluZHBsYWNlZnJvbXRleHQiLCJcL3BsYWNlXC9uZWFyYnlzZWFyY2giLCJcL3BsYWNlXC90ZXh0c2VhcmNoIiwiXC9wbGFjZVwvYXV0b2NvbXBsZXRlIiwiXC9kYXRhIiwiXC9zdHlsZXMiLCJcL3Nwcml0ZXMiLCJcL2ZvbnRzIiwiXC9yb3V0ZVwvZGlyZWN0aW9ucyIsIlwvcm91dGVcL2Rpc3RhbmNlbWF0cml4IiwiXC9yb3V0ZVwvdHJpcCIsIlwvcm9hZFwvbmVhcmVzdFJvYWRzIiwiXC9yb2FkXC9zbmFwVG9Sb2FkcyIsIlwvcm91dGVcL3ZycCIsIlwvYWRkcmVzc1wvc3RhbmRhcmRpemF0aW9uIl0sImV4cCI6MTcyMDE3MTgwNn0.Bk_GgGRH-vpYD-Rq4NDMa7XoiJ12LAadPBdTEA20Sh4';
                initMap();
            });

            function log(message) {
                console.log(`[${new Date().toISOString()}] ${message}`);
            }

            function initMap() {
                const initLatLng = [121.5173399, 25.0475613];
                const mapOptions = {
                    container: 'map8Map',
                    style: 'https://api.map8.zone/styles/go-life-maps-tw-style-std/style.json',
                    center: initLatLng,
                    zoom: 18,
                    pitch: 60,
                    bearing: 0,
                };

                map = new gomp.Map(mapOptions);
                map.addControl(new gomp.NavigationControl({ showZoom: false }));

                // 创建GeolocateControl
                const geolocateControl = new gomp.GeolocateControl({
                    positionOptions: {
                        enableHighAccuracy: true,
                    },
                    trackUserLocation: true,
                    showUserHeading: true,
                    showUserLocation: true,

                    maxZoom: 15 // 自訂縮放大小

                });

                // 将GeolocateControl添加到地图
                map.addControl(geolocateControl, 'bottom-right');

                gompWebServiceJsClient = new GompWebServiceJsClient({ key: gomp.accessToken });
                map8Route = new Map8Route({
                    gompWebServiceJsClient: gompWebServiceJsClient,
                });
                map.addControl(map8Route);

                // 监听地图加载完成事件
                map.on('load', function () {
                    /* 绑定GeolocateControl的点击事件
                    geolocateControl._container.onclick = handleGeolocateClick;*/
                    // 地图加载完成后自动触发geolocation
                    geolocateControl.trigger();

                    // 监听位置更新事件
                    geolocateControl.on('geolocate', function (e) {
                        const lon = e.coords.longitude;
                        const lat = e.coords.latitude;
                        const position = {
                            lat: lat,
                            lng: lon
                        };

                        // 更新用户位置
                        updateUserLocation(position);
                    });
                    startModal.show();
                    document.getElementById("destination").innerText = arrivalLatLng;
                });


                /*const logInfoToConsole = () => {
                    const center = map.getCenter();
                    const zoom = map.getZoom().toFixed(2);
                    const bearing = map.getBearing().toFixed(2);
                    const pitch = map.getPitch().toFixed(2);

                    console.log(`中心點: (${center.lng.toFixed(5)}, ${center.lat.toFixed(5)})`);
                    console.log(`縮放級別: ${zoom}`);
                    console.log(`方位角: ${bearing}`);
                    console.log(`俯仰角: ${pitch}`);
                };

                map.on('move', logInfoToConsole);
                map.on('zoom', logInfoToConsole);
                map.on('rotate', logInfoToConsole);
                map.on('pitch', logInfoToConsole);*/

                function updateUserLocation(position) {
                    // 更新位置历史

                    positionRecord.push([position.lng, position.lat]);

                    // 更新地图上的标记或其他需要的位置更新操作
                    if (nowposition == null) {
                        console.log(goState)
                        nowposition = new gomp.Marker({
                            position: position,
                            map: map,
                        });
                        NowLatLng = {
                            lat: LatLngtoFloor(position.lat),
                            lng: LatLngtoFloor(position.lng),
                        };
                        if (goState == true) {
                            console.log("執行記錄位置")
                            recordPosition(NowLatLng);
                        }
                    } else {
                        nowposition.setLngLat(position);
                        NowLatLng = {
                            lat: LatLngtoFloor(position.lat),
                            lng: LatLngtoFloor(position.lng),
                        };
                        if (goState == true) {
                            recordPosition(NowLatLng);
                        }
                    }
                    console.log(goState)
                    // 更新地图视图
                    map.setCenter(position);
                    
                    // 这里可以添加其他需要根据位置更新的逻辑
                    // 例如更新路线、计算距离等
                }
            }

            // 處理 GeolocateControl 點擊事件的函數
            function handleGeolocateClick(event) {
                // 防止事件冒泡和默認行為
                event.stopPropagation();
                event.preventDefault();

                // 獲取當前位置並執行 flyTo
                navigator.geolocation.getCurrentPosition(function (position) {
                    map.flyTo({
                        center: [position.coords.longitude, position.coords.latitude],
                        zoom: 17,
                        pitch: 60,
                        bearing: 0,
                        speed: 0.5,
                    });
                });
            }

            function addMarker(location, label) {
                for (let i = 0; i <= location.length - 1; i++) {
                    marker = new gomp.Marker({
                        position: location[i],
                        map: map,
                        label: label,
                    });

                    setTimeout(function () {
                        marker.remove();
                    }, 3000);
                }
            }

            function showToast(message, duration = 5000) {
                let toastElement = document.createElement("div");
                toastElement.classList.add("toast");
                toastElement.classList.add("show");

                toastElement.innerHTML = `
      <div class="toast-header">
        <strong class="me-auto">程式通知</strong>
        <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
      <div class="toast-body">
        ${message}
      </div>
    `;

                document.getElementById("toastContainer").appendChild(toastElement);

                setTimeout(function () {
                    toastElement.remove();
                }, duration);
            }
            function computeHeading(start, end) {
                const bearing = turf.bearing(
                    turf.point([start.lng, start.lat]),
                    turf.point([end.lng, end.lat])
                );
                return (bearing + 360) % 360; // 確保結果在 0-360 度範圍內
            }
            function headingCorrection(heading) {
                if (heading < 0) {
                    heading += 360;
                }
                return heading;
            }

            function formatDistance(distance) {
                if (distance >= 1000) {
                    const kilometers = (distance / 1000).toFixed(1);
                    return kilometers + " 公里後";
                } else {
                    const meters = Math.round(distance / 10) * 10;;
                    return meters + " 公尺後";
                }
            }

            function computeDistance(point1, point2) {
                const from = turf.point([point1.lng, point1.lat]);
                const to = turf.point([point2.lng, point2.lat]);
                const distance = turf.distance(from, to, { units: 'meters' });
                return Math.floor(distance);
            }

            function deg2rad(deg) {
                return deg * (Math.PI / 180);
            }

            function LatLngtoFloor(number) {
                let factor = Math.pow(10, 5);
                let truncatedNumber = Math.floor(number * factor) / factor;
                return truncatedNumber;
            }
            function recordPosition(position) {
                console.log("開始記錄位置");
                let currentStep = routeData.legs[0].steps[currentStepIndex];
                if (currentStepIndex < routeData.legs[0].steps.length - 1) {
                    nextStep = routeData.legs[0].steps[currentStepIndex + 1];
                } else {
                    nextStep = null;
                }
                /*NowLatLng = {
                    lat: LatLngtoFloor(position.coords.latitude),
                    lng: LatLngtoFloor(position.coords.longitude),
                };
                console.log(NowLatLng);*/
                if (positionRecord[positionRecord.length - 1]) {
                    moveDistance = computeDistance(positionRecord[positionRecord.length - 1], NowLatLng);
                }
                if (positionRecord[positionRecord.length - 1] !== NowLatLng && moveDistance > 5) {
                    positionRecord.push(NowLatLng);
                }
                positionRecord.forEach((currentValue, index) => {
                    if (index > 0) {
                        const previousPoint = positionRecord[index - 1];
                        const distance = computeDistance(previousPoint, currentValue);
                        estimatedDistance += distance;
                        if (index === positionRecord.length - 1) {
                            estimatedDistance = Math.floor(estimatedDistance / 1000);
                        }
                    }
                });
                if (cardTextFare) {
                    let nowTimer = (Date.now() - startTime) / 600;
                    cardTextFare.innerHTML =
                        "目前車資：" +
                        (50 + Math.floor(nowTimer) * 2 + estimatedDistance * 20) +
                        "元";
                }
                let heading =
                    computeHeading(NowLatLng, findNextPointsToCurrentLocationTest(NowLatLng, routeData.geometry.coordinates.map((coord) => ({ lat: coord[1], lng: coord[0] }))));
                let distance = computeDistance(NowLatLng, currentStep.start_location);
                nowposition.setLngLat(NowLatLng);
                map.setBearing(heading);
                map.setCenter(NowLatLng);
                map.setZoom(17);
                map.setPitch(80);

                if (booleanPointOnLine(NowLatLng, Pathpolyline)) {
                    let stepPath = decodePath(stepsPath[currentStepIndex]);
                    let stepPolyline = new gomp.Polyline({
                        path: stepPath,
                    });
                    if (currentStepIndex < stepsPath.length - 1) {
                        currentStepIndex++;
                        let distance = computeDistance(NowLatLng, nextStep.start_location);
                        cardTextDistance.innerHTML = formatDistance(distance) + "後";
                        cardTextInstruction.innerHTML = nextStep.maneuver.instruction;
                        log("下一步：" + nextStep.maneuver.instruction);
                    } else {
                        cardTextDistance.innerHTML = formatDistance(distance) + "後";
                        cardTextInstruction.innerHTML = currentStep.maneuver.instruction;
                        endJourney();
                        log("最後一步：" + currentStep.maneuver.instruction);
                    }
                } else {
                    calcRoute(NowLatLng, arrivalLatLng);
                    map.setCenter(NowLatLng);
                    log("重新計算路線");
                }
            }

            function showError(error) {
                console.log("Error getting location: " + error.message);
            }

            function startJourney() {
                if (startTime == null) {
                    startTime = Date.now();
                    Timer += Math.floor((endTime - startTime) / 1000);
                    console.log("待機時間" + Timer + "秒");
                    endTime = null;
                }
                goState = true;
                
                calcRoute(NowLatLng, arrivalLatLng);
            }

            function endJourney() {
                positionRecord.forEach((currentValue, index) => {
                    if (index > 0) {
                        const previousPoint = positionRecord[index - 1];
                        const distance = computeDistance(previousPoint, currentValue);
                        totalMoveLength += distance;
                        if (index === positionRecord.length - 1) {
                            totalMoveLength = Math.floor(totalMoveLength / 1000);
                        }
                    }
                });
                endTime = Date.now();
                Timer = Math.floor((endTime - startTime) / 600);
                console.log("結算中...");
                final_time = Timer;
                final_distance = totalMoveLength;

                if (totalDistanceElement && totalFareElement) {
                    final_fare = base_fare + Timer * 2 + totalMoveLength * 20;
                    totalDistanceElement.innerText = final_distance + " 公里";
                    if (final_fare < 100 || isNaN(final_fare)) {
                        final_fare = 100;
                    }
                    totalFareElement.innerText = final_fare + " 元";
                }

            }

            function findNextPointsToCurrentLocationTest(currentLocation, overviewPath) {
                const coordinates = overviewPath;
                const currentPoint = currentLocation;
                for (let i = coordinates.length - 1; i >= 0; i -= 1) {
                    let startPoint = coordinates[i];
                    let endPoint = coordinates[i - 1];
                    console.log(startPoint.lat + "," + startPoint.lng + " index :" + i);
                    console.log(endPoint.lat + "," + endPoint.lng + " index :" + (i - 1));
                    const polyline = new gomp.Polyline({
                        path: [startPoint, endPoint],
                        geodesic: true,
                    });
                    if (booleanPointOnLine(currentPoint, polyline, 0.0003)) {
                        addMarker(startPoint, "T");
                        console.log(startPoint.lat + "," + startPoint.lng);
                        return startPoint;
                    } else {
                        continue;
                    }
                }
                addMarker(overviewPath[1], "O");
                return overviewPath[1];
            }

            function computeOffsetLatLng(currentLocation) {
                let latestRecord = positionRecord[positionRecord.length - 2];
                let heading = headingCorrection(computeHeading(latestRecord, currentLocation));
                let offsetLatLng = gomp.geometry.spherical.computeOffset(currentLocation, 50, heading);
                addMarker(offsetLatLng, "F");
                return offsetLatLng;
            }

            function getPosition() {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(function (position) {
                        let latLng = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude,
                        };
                        departureLatLng = latLng;
                        map.setZoom(16);
                        map.setPitch(80);
                        map.setCenter(latLng);
                        if (nowposition == null) {
                            nowposition = new gomp.Marker({
                                position: latLng,
                                map: map,

                            });
                        } else {
                            nowposition.remove();
                            nowposition = new gomp.Marker({
                                position: latLng,
                                map: map,

                            });
                        }
                    });
                    startModal.show();
                } else {
                    alert("Geolocation is not supported by this browser.");
                }
            }

            async function calcRoute(origin, destination) {
                const query = await fetch(
                    `https://api.map8.zone/route/car/${NowLatLng.lng},${NowLatLng.lat};${arrivalLatLng[0]},${arrivalLatLng[1]}.json?key=${gomp.accessToken}&steps=${true}&alternatives=${true}`,
                    { method: 'GET' }
                );
                json = await query.json();
                console.log(json);
                const routeData = json.routes[0];
                route = routeData.geometry.coordinates;
                stepsPath = routeData.legs[0].steps;
                console.log(stepsPath);
                const geojson = {
                    type: 'Feature',
                    properties: {},
                    geometry: {
                        type: 'LineString',
                        coordinates: route
                    }
                };
                // if the route already exists on the map, we'll reset it using setData
                if (map.getSource('route')) {
                    map.getSource('route').setData(geojson);
                }
                // otherwise, we'll make a new request
                else {
                    map.addLayer({
                        id: 'route',
                        type: 'line',
                        source: {
                            type: 'geojson',
                            data: geojson
                        },
                        layout: {
                            'line-join': 'round',
                            'line-cap': 'round'
                        },
                        paint: {
                            'line-color': '#3887be',
                            'line-width': 5,
                            'line-opacity': 0.75
                        }
                    });

                    /*stepsPath.forEach(step => {
                        const marker = new gomp.Marker()
                            .setLngLat(step.maneuver.location)
                            .setPopup(new gomp.Popup({ offset: 25 }) // add popups
                                .setHTML(`<h3>Type: ${step.maneuver.type}</h3><p>動作:${step.maneuver.modifier}</p><p>指示: ${step.name}</p>`))
                            .addTo(map);
                    });*/

                };

                //countStepTypes(stepsPath);

                document.getElementById("prevButton").addEventListener("click", function () {
                    if (currentStepIndex > 0) {
                        currentStepIndex--;
                        updateInstruction();
                    }
                });

                document.getElementById("nextButton").addEventListener("click", function () {
                    if (currentStepIndex < stepsPath.length - 1) {
                        currentStepIndex++;
                        updateInstruction();
                    }
                });
            }
            // add turn instructions here at the end
            function translateInstruction(instruction) {
                const translations = {
                    'uturn': '迴轉',
                    'straight': '直行',
                    'left': '向左轉',
                    'right': '向右轉',
                    'slight left': '微向左轉',
                    'slight right': '微向右轉',
                    'sharp left': '向左急轉',
                    'sharp right': '向右急轉',

                };
                return translations[instruction] || instruction;
            }

            function countStepTypes(steps) {
                const typeCounts = {};
                steps.forEach(step => {
                    const type = step.maneuver.type;
                    if (typeCounts[type]) {
                        typeCounts[type]++;
                    } else {
                        typeCounts[type] = 1;
                    }
                });

                /*console.log("各 type 的数量:");
                for (const type in typeCounts) {
                    console.log(`${type}: ${typeCounts[type]}個`);
                }*/
            }

            function updateInstruction() {
                document.getElementById("card-distance").innerText = formatDistance(Math.floor(stepsPath[currentStepIndex].distance));
                document.getElementById("card-instruction").innerText = translateInstruction(stepsPath[currentStepIndex].maneuver.modifier) + '進入' + stepsPath[currentStepIndex].name;
            }

            document.getElementById("prevButton").addEventListener("click", function () {
                if (currentStepIndex > 0) {
                    currentStepIndex--;
                    updateInstruction();
                }
            });

            document.getElementById("nextButton").addEventListener("click", function () {
                if (currentStepIndex < stepsPath.length - 1) {
                    currentStepIndex++;
                    updateInstruction();
                }
            });

            window.initMap = initMap;

        </script>
    </div>
</body>

</html>
